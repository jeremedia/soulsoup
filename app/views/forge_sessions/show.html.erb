<%= turbo_stream_from "forge_session_#{@forge_session.id}" %>

<div class="session-header">
  <div class="session-title">
    <h1><%= @forge_session.forge.name %> Session</h1>
    <div class="session-meta">
      <span class="session-id">ID: <%= @forge_session.session_id %></span>
      <span id="session_status" class="session-status <%= @forge_session.status %>">
        Status: <span class="badge <%= @forge_session.status %>"><%= @forge_session.status.titleize %></span>
      </span>
    </div>
  </div>
  
  <div class="session-actions">
    <% if @forge_session.can_start? %>
      <%= button_to "Start Session", start_forge_session_path(@forge_session), method: :patch, class: "btn btn-primary" %>
    <% elsif @forge_session.active? %>
      <%= button_to "End Session", end_forge_session_path(@forge_session), method: :patch, class: "btn btn-danger", 
                    params: { winner: 'manual', reason: 'Manual termination' }, 
                    confirm: "Are you sure you want to end this session?" %>
    <% end %>
    <%= link_to "Back to Sessions", forge_sessions_path, class: "btn btn-secondary" %>
  </div>
</div>

<% if @forge_session.status == 'completed' && @forge_session.session_data['outcome'] %>
<div class="session-outcome">
  <h2>Session Outcome</h2>
  <div class="outcome-details">
    <% outcome = @forge_session.session_data['outcome'] %>
    <div class="outcome-item">
      <span class="outcome-label">Result:</span>
      <span class="outcome-value <%= outcome['winner'] ? 'winner' : 'no-winner' %>">
        <% if outcome['winner'] %>
          <% team_names = ['RED', 'BLUE', 'GREEN', 'YELLOW', 'PINK'] %>
          <%= team_names[outcome['winner']] || "TEAM #{outcome['winner']}" %> TEAM WINS!
        <% else %>
          <%= outcome['condition']&.humanize || 'No winner' %>
        <% end %>
      </span>
    </div>
    <% if outcome['reason'] %>
    <div class="outcome-item">
      <span class="outcome-label">Reason:</span>
      <span class="outcome-value"><%= outcome['reason'] %></span>
    </div>
    <% end %>
    <% if @forge_session.duration %>
    <div class="outcome-item">
      <span class="outcome-label">Total Duration:</span>
      <span class="outcome-value"><%= (@forge_session.duration / 60).round(1) %> minutes</span>
    </div>
    <% end %>
  </div>
</div>
<% end %>

<div class="session-stats">
  <div class="stat-item">
    <span class="stat-label">Duration:</span>
    <span class="stat-value">
      <% if @forge_session.started_at %>
        <%= time_ago_in_words(@forge_session.started_at) %>
      <% else %>
        Not started
      <% end %>
    </span>
  </div>
  <div class="stat-item">
    <span class="stat-label">Participants:</span>
    <span class="stat-value">
      <%= @forge_session.incarnations.active.count %>/<%= @forge_session.forge.max_participants %>
    </span>
  </div>
  <div class="stat-item">
    <span class="stat-label">Forge Type:</span>
    <span class="stat-value"><%= @forge_session.forge.type %></span>
  </div>
</div>

<div id="session_teams" class="teams-grid">
  <% @teams.each do |team| %>
    <%= render "team_panel", session: @forge_session, team: team, team_data: @team_data[team] %>
  <% end %>
</div>

<style>
.session-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #333;
}

.session-title h1 {
  color: #0f0;
  margin: 0 0 0.5rem 0;
}

.session-meta {
  display: flex;
  gap: 1rem;
  font-size: 0.9rem;
  color: #ccc;
}

.session-actions {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.session-actions form.button_to {
  display: inline-block;
  margin: 0;
}

.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 3px;
  text-decoration: none;
  cursor: pointer;
  text-transform: uppercase;
  font-weight: bold;
  font-size: 0.8rem;
  display: inline-block;
  line-height: 1.25rem;
  vertical-align: middle;
}

.btn-primary { background: #0f0; color: #000; }
.btn-primary:hover { background: #0c0; }
.btn-danger { background: #f00; color: #fff; }
.btn-danger:hover { background: #c00; }
.btn-secondary { background: #666; color: #fff; }
.btn-secondary:hover { background: #555; }

.session-stats {
  display: flex;
  gap: 2rem;
  margin-bottom: 2rem;
  padding: 1rem;
  background: #111;
  border-radius: 5px;
}

.stat-item {
  display: flex;
  flex-direction: column;
  gap: 0.2rem;
}

.stat-label {
  font-size: 0.8rem;
  color: #999;
  text-transform: uppercase;
}

.stat-value {
  color: #0f0;
  font-weight: bold;
}

.badge {
  padding: 0.2rem 0.5rem;
  border-radius: 3px;
  font-size: 0.7rem;
  text-transform: uppercase;
}

.badge.waiting { background: #fa0; color: #000; }
.badge.active { background: #0f0; color: #000; }
.badge.completed { background: #666; color: #fff; }

.teams-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1rem;
}

.session-outcome {
  background: #1a1a1a;
  border: 2px solid #444;
  border-radius: 5px;
  padding: 1.5rem;
  margin-bottom: 2rem;
}

.session-outcome h2 {
  color: #0f0;
  margin: 0 0 1rem 0;
  font-size: 1.2rem;
  text-transform: uppercase;
}

.outcome-details {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.outcome-item {
  display: flex;
  gap: 1rem;
  align-items: baseline;
}

.outcome-label {
  color: #999;
  font-size: 0.9rem;
  text-transform: uppercase;
  min-width: 120px;
}

.outcome-value {
  color: #fff;
  font-weight: bold;
}

.outcome-value.winner {
  color: #0f0;
  font-size: 1.2rem;
  text-shadow: 0 0 10px #0f0;
}

.outcome-value.no-winner {
  color: #fa0;
}
</style>